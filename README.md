# Spring AI Azure OpenAI - Reordering issue

This repository contains a sample project for reproducing an ordering issue with Spring AI and Azure OpenAI when using the streaming chat model.
It can be reproduced with and without tool calls.

The issue
```
data: <A>
data: <B>
```
might be received in the wrong order (`<B>` -> `<A>`, even if the application does not do anything with the response stream except collecting it.

## Test Data

Test data was generated by:
* Observing the actual SSE stream from an Azure OpenAI chat completion request
* Creating a test case that mimics the observed behavior
  * See `data_generator.py` for the script that generates the test data
  * See `test/resources/wiremock` for the WireMock setup that serves the stubbed Azure OpenAI responses

## Reproducing the issue

See tests in `src/test/java/com/example/springaiazureopenai/SpringAiAzureOpenAiApplicationTests.java`.
There is one test case with tool calls (using a WireMock scenario) and one without tool calls.
Reproducing is a numbers-game with this setup as it relies on triggering a race condition.
On my machine I can trigger the issue
* 1 out of 500 runs
* 1 out of 5k runs

The issue was much more pronounced on a real deployment with parallel requests, with a resource-constrained service.

The tests run 10k times each, so the issue _should_ be reproducible.
However, it is not guaranteed that it will be triggered.
